# FlexStorage Test Plan

**Version:** 1.0.0
**Testing Framework:** xUnit, FluentAssertions
**Approach:** Test-Driven Development (TDD) - Red, Green, Refactor
**Architecture:** Domain-Driven Design (DDD) - Inside-Out Testing

---

## Testing Strategy

### Test Order Rationale
1. **Domain Layer First** (No dependencies, pure business logic)
2. **Application Layer** (Depends on Domain)
3. **Infrastructure Layer** (Depends on Domain & Application interfaces)
4. **API Layer** (Depends on all layers)
5. **Integration Tests** (End-to-end flows)

### TDD Cycle
```
RED ‚Üí GREEN ‚Üí REFACTOR
Write failing test ‚Üí Make it pass ‚Üí Improve code
```

---

## Test Execution Checklist

### Legend
- ‚¨ú Not Started
- üîÑ In Progress
- ‚úÖ Tests Written & Passing
- ‚ùå Tests Failing
- ‚è∏Ô∏è Blocked/Deferred

---

## Phase 1: Domain Layer - Value Objects

**Goal:** Build foundation with no dependencies
**Estimated Tests:** 35-40 test cases

### 1.1 FileSize Value Object
- ‚¨ú Should create valid file size with bytes
- ‚¨ú Should reject negative file size
- ‚¨ú Should reject zero file size
- ‚¨ú Should convert bytes to KB correctly
- ‚¨ú Should convert bytes to MB correctly
- ‚¨ú Should convert bytes to GB correctly
- ‚¨ú Should compare file sizes correctly (equality)
- ‚¨ú Should compare file sizes correctly (greater than)
- ‚¨ú Should compare file sizes correctly (less than)
- ‚¨ú Should enforce maximum size limit (5GB)
- ‚¨ú Should return human-readable format (e.g., "1.5 MB")

**Test Class:** `FileSizeTests.cs`
**Dependencies:** None

---

### 1.2 FileType Value Object
- ‚¨ú Should create valid photo type from JPEG MIME type
- ‚¨ú Should create valid photo type from PNG MIME type
- ‚¨ú Should create valid photo type from HEIC MIME type
- ‚¨ú Should create valid video type from MP4 MIME type
- ‚¨ú Should create valid video type from MOV MIME type
- ‚¨ú Should create valid misc type from PDF MIME type
- ‚¨ú Should reject invalid/unknown MIME type
- ‚¨ú Should map MIME type to file extension correctly
- ‚¨ú Should recommend storage tier based on type (photo ‚Üí deep archive)
- ‚¨ú Should recommend storage tier based on type (video ‚Üí flexible)
- ‚¨ú Should categorize file as photo/video/misc correctly
- ‚¨ú Should validate file extension matches MIME type

**Test Class:** `FileTypeTests.cs`
**Dependencies:** None

---

### 1.3 StorageLocation Value Object
- ‚¨ú Should create valid storage location with provider and path
- ‚¨ú Should reject null provider name
- ‚¨ú Should reject empty provider name
- ‚¨ú Should reject null storage path
- ‚¨ú Should reject empty storage path
- ‚¨ú Should validate path format (starts with provider scheme)
- ‚¨ú Should support equality comparison (same provider and path)
- ‚¨ú Should parse location string correctly
- ‚¨ú Should generate location string correctly

**Test Class:** `StorageLocationTests.cs`
**Dependencies:** None

---

### 1.4 UploadStatus Value Object
- ‚¨ú Should initialize with Pending status
- ‚¨ú Should transition from Pending to Uploading
- ‚¨ú Should transition from Uploading to Completed
- ‚¨ú Should transition from Uploading to Failed
- ‚¨ú Should transition from Completed to Archived
- ‚¨ú Should reject invalid transition (Pending to Archived)
- ‚¨ú Should reject invalid transition (Completed to Uploading)
- ‚¨ú Should track timestamp of status change
- ‚¨ú Should prevent changes after Archived status
- ‚¨ú Should allow transition from Failed to Pending (retry)

**Test Class:** `UploadStatusTests.cs`
**Dependencies:** None

---

## Phase 2: Domain Layer - Entities

**Goal:** Core business entities
**Estimated Tests:** 30-35 test cases

### 2.1 FileMetadata Entity
- ‚¨ú Should create metadata with required properties
- ‚¨ú Should validate filename is not null
- ‚¨ú Should validate filename is not empty
- ‚¨ú Should sanitize filename (remove special characters)
- ‚¨ú Should store original filename separately
- ‚¨ú Should validate SHA256 hash format
- ‚¨ú Should store content hash
- ‚¨ú Should store creation timestamp automatically
- ‚¨ú Should update modification timestamp when changed
- ‚¨ú Should store optional user tags
- ‚¨ú Should store optional description
- ‚¨ú Should store MIME type
- ‚¨ú Should store GPS coordinates if provided
- ‚¨ú Should store device metadata if provided

**Test Class:** `FileMetadataTests.cs`
**Dependencies:** None

---

### 2.2 File Entity (Aggregate Root)
- ‚¨ú Should create file with required properties
- ‚¨ú Should generate unique file ID (GUID)
- ‚¨ú Should initialize with Pending status
- ‚¨ú Should assign file size
- ‚¨ú Should assign file type
- ‚¨ú Should associate file metadata
- ‚¨ú Should update status via domain method only
- ‚¨ú Should track upload progress percentage
- ‚¨ú Should raise FileUploadStarted domain event
- ‚¨ú Should raise FileUploadCompleted domain event
- ‚¨ú Should raise FileArchived domain event
- ‚¨ú Should prevent modification after archived
- ‚¨ú Should prevent status update after archived
- ‚¨ú Should store storage location when archived
- ‚¨ú Should validate file size within limits
- ‚¨ú Should support adding user tags after creation

**Test Class:** `FileEntityTests.cs`
**Dependencies:** FileMetadata, FileSize, FileType, UploadStatus, StorageLocation

---

## Phase 3: Domain Layer - Domain Services

**Goal:** Business logic that doesn't belong to single entity
**Estimated Tests:** 25-30 test cases

### 3.1 IStorageProvider Interface (Contract Tests)
- ‚¨ú Should define UploadAsync method signature
- ‚¨ú Should define DownloadAsync method signature
- ‚¨ú Should define InitiateRetrievalAsync method signature
- ‚¨ú Should define DeleteAsync method signature
- ‚¨ú Should define CheckHealthAsync method signature
- ‚¨ú Should return provider name
- ‚¨ú Should return provider capabilities

**Test Class:** `IStorageProviderContractTests.cs`
**Dependencies:** None
**Note:** Contract test, not implementation

---

### 3.2 StorageProviderSelector Domain Service
- ‚¨ú Should select S3 Deep Archive for photos by default
- ‚¨ú Should select S3 Flexible for large videos
- ‚¨ú Should select Backblaze for frequently accessed files
- ‚¨ú Should respect user-specified provider preference
- ‚¨ú Should fallback to default provider if preference unavailable
- ‚¨ú Should validate provider is enabled before selection
- ‚¨ú Should consider file size in selection logic
- ‚¨ú Should consider file type in selection logic
- ‚¨ú Should throw exception if no providers available
- ‚¨ú Should select cheapest provider when multiple match

**Test Class:** `StorageProviderSelectorTests.cs`
**Dependencies:** FileType, FileSize, IStorageProvider

---

### 3.3 FileHashCalculator Domain Service
- ‚¨ú Should calculate SHA256 hash from stream
- ‚¨ú Should return hash in hex format
- ‚¨ú Should handle empty file (empty hash)
- ‚¨ú Should handle large files without memory issues
- ‚¨ú Should produce consistent hash for same content
- ‚¨ú Should produce different hash for different content

**Test Class:** `FileHashCalculatorTests.cs`
**Dependencies:** None

---

## Phase 4: Application Layer - Repository Interfaces

**Goal:** Define data access contracts
**Estimated Tests:** 15-20 test cases

### 4.1 IFileRepository Interface
- ‚¨ú Should define AddAsync method
- ‚¨ú Should define GetByIdAsync method
- ‚¨ú Should define UpdateAsync method
- ‚¨ú Should define DeleteAsync method (soft delete)
- ‚¨ú Should define GetByUserIdAsync with pagination
- ‚¨ú Should define SearchAsync with filters
- ‚¨ú Should define ExistsByHashAsync for deduplication
- ‚¨ú Should support unit of work pattern

**Test Class:** `IFileRepositoryContractTests.cs`
**Dependencies:** File Entity
**Note:** Interface only, implementation tested in Infrastructure

---

### 4.2 IUploadSessionRepository Interface
- ‚¨ú Should define CreateSessionAsync
- ‚¨ú Should define GetSessionAsync
- ‚¨ú Should define UpdateSessionAsync
- ‚¨ú Should define DeleteSessionAsync
- ‚¨ú Should define GetExpiredSessionsAsync

**Test Class:** `IUploadSessionRepositoryContractTests.cs`
**Dependencies:** None

---

## Phase 5: Application Layer - Application Services

**Goal:** Use cases and orchestration
**Estimated Tests:** 60-70 test cases

### 5.1 FileUploadService (Simple Upload)
- ‚¨ú Should validate file size before upload
- ‚¨ú Should validate file type before upload
- ‚¨ú Should reject file exceeding size limit
- ‚¨ú Should reject invalid file type
- ‚¨ú Should calculate file hash
- ‚¨ú Should check for duplicate file by hash
- ‚¨ú Should skip upload if duplicate found
- ‚¨ú Should return existing file ID if duplicate
- ‚¨ú Should select appropriate storage provider
- ‚¨ú Should generate unique storage path
- ‚¨ú Should upload file to selected provider
- ‚¨ú Should save file metadata to repository
- ‚¨ú Should update file status to Completed after upload
- ‚¨ú Should handle upload failure and set status to Failed
- ‚¨ú Should rollback metadata if upload fails
- ‚¨ú Should emit FileUploadStarted event
- ‚¨ú Should emit FileUploadCompleted event
- ‚¨ú Should queue thumbnail generation job asynchronously

**Test Class:** `FileUploadServiceTests.cs`
**Dependencies:** IFileRepository, IStorageProvider, StorageProviderSelector, FileHashCalculator

---

### 5.2 ChunkedUploadService
- ‚¨ú Should initiate upload session with file metadata
- ‚¨ú Should generate upload ID (GUID)
- ‚¨ú Should calculate number of chunks needed
- ‚¨ú Should set chunk size to 5MB by default
- ‚¨ú Should generate presigned URLs for each chunk
- ‚¨ú Should set session expiration to 24 hours
- ‚¨ú Should save upload session to repository
- ‚¨ú Should track uploaded chunk parts
- ‚¨ú Should validate chunk MD5 hash
- ‚¨ú Should reject chunk with invalid MD5
- ‚¨ú Should update session progress after each chunk
- ‚¨ú Should complete upload when all chunks uploaded
- ‚¨ú Should assemble chunks in correct order
- ‚¨ú Should verify final file hash matches expected
- ‚¨ú Should handle upload resumption (return uploaded parts)
- ‚¨ú Should cancel upload and cleanup resources
- ‚¨ú Should expire upload session after 24 hours
- ‚¨ú Should cleanup expired sessions via background job

**Test Class:** `ChunkedUploadServiceTests.cs`
**Dependencies:** IUploadSessionRepository, IFileRepository, IStorageProvider

---

### 5.3 FileRetrievalService
- ‚¨ú Should retrieve file metadata by ID
- ‚¨ú Should return 404 if file not found
- ‚¨ú Should generate direct download URL for non-Glacier files
- ‚¨ú Should initiate Glacier retrieval for archived files
- ‚¨ú Should select retrieval tier (bulk, standard, expedited)
- ‚¨ú Should save retrieval request to database
- ‚¨ú Should return estimated retrieval time
- ‚¨ú Should poll retrieval status from provider
- ‚¨ú Should generate time-limited download URL when ready
- ‚¨ú Should set download URL expiration to 24 hours
- ‚¨ú Should validate user has permission to retrieve file
- ‚¨ú Should track retrieval request in database
- ‚¨ú Should expire retrieval request after timeout
- ‚¨ú Should send webhook notification when retrieval ready

**Test Class:** `FileRetrievalServiceTests.cs`
**Dependencies:** IFileRepository, IStorageProvider

---

### 5.4 ThumbnailGenerationService
- ‚¨ú Should generate 3 thumbnail sizes for images (150, 300, 600)
- ‚¨ú Should use WebP format for thumbnails
- ‚¨ú Should maintain aspect ratio when resizing
- ‚¨ú Should set quality to 85% by default
- ‚¨ú Should generate thumbnails asynchronously via job queue
- ‚¨ú Should store thumbnails in S3 Standard (not Glacier)
- ‚¨ú Should use CDN for thumbnail delivery
- ‚¨ú Should support lazy generation (on first request, then cache)
- ‚¨ú Should generate 3 preview frames for videos (25%, 50%, 75%)
- ‚¨ú Should generate 10-second preview clip for videos
- ‚¨ú Should handle thumbnail generation failure gracefully
- ‚¨ú Should skip thumbnail generation for unsupported types
- ‚¨ú Should cache thumbnail URLs in file metadata
- ‚¨ú Should return 202 if thumbnail still generating
- ‚¨ú Should return cached thumbnail URL if available

**Test Class:** `ThumbnailGenerationServiceTests.cs`
**Dependencies:** IFileRepository, IStorageProvider, Job Queue Interface

---

### 5.5 HashComparisonService
- ‚¨ú Should accept batch of up to 1000 hashes
- ‚¨ú Should reject batch exceeding 1000 hashes
- ‚¨ú Should query repository for each hash
- ‚¨ú Should return exists=true if hash found
- ‚¨ú Should return exists=false if hash not found
- ‚¨ú Should include file ID if hash exists
- ‚¨ú Should include upload status if hash exists
- ‚¨ú Should mark safeToDeleteLocally=true if status is Archived
- ‚¨ú Should mark safeToDeleteLocally=false if status is Uploading
- ‚¨ú Should optimize batch query performance
- ‚¨ú Should return results in same order as input
- ‚¨ú Should handle database errors gracefully

**Test Class:** `HashComparisonServiceTests.cs`
**Dependencies:** IFileRepository

---

### 5.6 StorageProviderFactory
- ‚¨ú Should register multiple providers in DI
- ‚¨ú Should create provider instance by name
- ‚¨ú Should throw exception if provider not found
- ‚¨ú Should throw exception if provider name is null
- ‚¨ú Should support lazy loading of providers
- ‚¨ú Should validate provider configuration on startup
- ‚¨ú Should discover plugins from directory
- ‚¨ú Should load provider from external assembly
- ‚¨ú Should validate plugin implements IStorageProvider
- ‚¨ú Should handle plugin load failure gracefully

**Test Class:** `StorageProviderFactoryTests.cs`
**Dependencies:** IStorageProvider

---

## Phase 6: Application Layer - Rate Limiting & Quota

**Estimated Tests:** 30-35 test cases

### 6.1 RateLimitingService
- ‚¨ú Should enforce Free tier upload limit (10/hour)
- ‚¨ú Should enforce Standard tier upload limit (100/hour)
- ‚¨ú Should enforce Premium tier upload limit (1000/hour)
- ‚¨ú Should enforce daily bandwidth limit for Free tier
- ‚¨ú Should enforce daily bandwidth limit for Standard tier
- ‚¨ú Should enforce daily bandwidth limit for Premium tier
- ‚¨ú Should reject upload when hourly limit exceeded
- ‚¨ú Should reject upload when daily limit exceeded
- ‚¨ú Should reset hourly counter after 1 hour
- ‚¨ú Should reset daily counter after 24 hours
- ‚¨ú Should return correct rate limit headers
- ‚¨ú Should return retry-after time when rate limited
- ‚¨ú Should throttle S3 requests to configured limit (50/sec for Deep)
- ‚¨ú Should throttle S3 requests to configured limit (100/sec for Flex)
- ‚¨ú Should not throttle Backblaze (1000/sec)
- ‚¨ú Should batch uploads to S3 Deep Archive when enabled
- ‚¨ú Should calculate cost of request and throttle if needed
- ‚¨ú Should allow bypass of throttling for Premium users

**Test Class:** `RateLimitingServiceTests.cs`
**Dependencies:** User profile, Configuration

---

### 6.2 QuotaManagementService
- ‚¨ú Should track total quota per user
- ‚¨ú Should track quota per provider
- ‚¨ú Should calculate used space per provider
- ‚¨ú Should calculate remaining space per provider
- ‚¨ú Should reject upload if total quota exceeded
- ‚¨ú Should reject upload if provider quota exceeded
- ‚¨ú Should increment used space after successful upload
- ‚¨ú Should decrement used space after file deletion
- ‚¨ú Should calculate usage percentage
- ‚¨ú Should recommend rebalancing when providers uneven (>20% difference)
- ‚¨ú Should emit warning event at 80% quota
- ‚¨ú Should emit exceeded event at 100% quota
- ‚¨ú Should support quota increase via admin operation
- ‚¨ú Should track file count per provider

**Test Class:** `QuotaManagementServiceTests.cs`
**Dependencies:** IFileRepository, User profile

---

## Phase 7: Application Layer - Advanced Features

**Estimated Tests:** 40-50 test cases

### 7.1 RedundancyManagementService
- ‚¨ú Should create 1 copy for "none" redundancy profile
- ‚¨ú Should create 2 copies for "standard" redundancy profile
- ‚¨ú Should create 3 copies for "paranoid" redundancy profile
- ‚¨ú Should distribute copies to different providers
- ‚¨ú Should distribute copies to different regions
- ‚¨ú Should queue redundancy job when requested
- ‚¨ú Should handle Glacier retrieval delay for copying
- ‚¨ú Should verify checksum after creating copy
- ‚¨ú Should update file metadata with copy locations
- ‚¨ú Should calculate redundancy health score (0-100)
- ‚¨ú Should detect missing redundant copy
- ‚¨ú Should auto-repair missing copy
- ‚¨ú Should verify checksums periodically (weekly)
- ‚¨ú Should emit alert if redundancy check fails
- ‚¨ú Should skip redundancy for temporary files

**Test Class:** `RedundancyManagementServiceTests.cs`
**Dependencies:** IFileRepository, IStorageProvider, Background Jobs

---

### 7.2 FileRebalancingService
- ‚¨ú Should identify files to move based on criteria (rarely-accessed)
- ‚¨ú Should calculate cost estimate for rebalancing
- ‚¨ú Should create rebalancing job
- ‚¨ú Should schedule job for off-peak hours if requested
- ‚¨ú Should retrieve file from source provider (handle Glacier delay)
- ‚¨ú Should upload file to target provider
- ‚¨ú Should verify file integrity after move
- ‚¨ú Should update file metadata with new location
- ‚¨ú Should optionally delete from source provider
- ‚¨ú Should track progress (files processed, bytes transferred)
- ‚¨ú Should handle failures and retry
- ‚¨ú Should throttle bandwidth if rate limit specified
- ‚¨ú Should calculate actual cost vs estimated
- ‚¨ú Should emit completion event
- ‚¨ú Should support cost-optimize strategy
- ‚¨ú Should support performance-optimize strategy
- ‚¨ú Should support even-distribute strategy

**Test Class:** `FileRebalancingServiceTests.cs`
**Dependencies:** IFileRepository, IStorageProvider, Background Jobs

---

### 7.3 FileSearchService
- ‚¨ú Should search by filename
- ‚¨ú Should search by tags (exact match)
- ‚¨ú Should search by tags (partial match)
- ‚¨ú Should search by date range
- ‚¨ú Should search by file type (photo, video, misc)
- ‚¨ú Should search by MIME type
- ‚¨ú Should search by size range
- ‚¨ú Should search by provider
- ‚¨ú Should combine multiple filters (AND logic)
- ‚¨ú Should support full-text search in metadata
- ‚¨ú Should return paginated results
- ‚¨ú Should sort by relevance score
- ‚¨ú Should sort by date (newest first)
- ‚¨ú Should sort by size (largest first)
- ‚¨ú Should highlight matched terms in results
- ‚¨ú Should return total count of results

**Test Class:** `FileSearchServiceTests.cs`
**Dependencies:** IFileRepository

---

### 7.4 FileSharingService
- ‚¨ú Should create public share with unique share ID
- ‚¨ú Should generate short URL for sharing
- ‚¨ú Should set expiration date if provided
- ‚¨ú Should set share to never expire if not provided
- ‚¨ú Should require password if specified
- ‚¨ú Should validate password on access
- ‚¨ú Should track download count
- ‚¨ú Should enforce max download limit if set
- ‚¨ú Should reject access after expiration
- ‚¨ú Should reject access after max downloads reached
- ‚¨ú Should generate time-limited download URL
- ‚¨ú Should validate user owns file before sharing
- ‚¨ú Should allow share revocation
- ‚¨ú Should list all shares for a file
- ‚¨ú Should update share settings
- ‚¨ú Should log share access events

**Test Class:** `FileSharingServiceTests.cs`
**Dependencies:** IFileRepository, IShareRepository, IStorageProvider

---

## Phase 8: Infrastructure Layer - Storage Providers

**Estimated Tests:** 50-60 test cases

### 8.1 S3GlacierDeepArchiveProvider
- ‚¨ú Should upload file to S3 using AWS SDK
- ‚¨ú Should set storage class to DEEP_ARCHIVE
- ‚¨ú Should generate unique S3 key
- ‚¨ú Should calculate and set Content-MD5 header
- ‚¨ú Should handle AWS SDK exceptions
- ‚¨ú Should retry on transient failures (3 retries)
- ‚¨ú Should initiate Glacier retrieval (bulk tier)
- ‚¨ú Should initiate Glacier retrieval (standard tier)
- ‚¨ú Should initiate Glacier retrieval (expedited tier)
- ‚¨ú Should poll retrieval job status
- ‚¨ú Should generate presigned download URL when ready
- ‚¨ú Should delete archived file
- ‚¨ú Should check provider health (test connection)
- ‚¨ú Should return provider name
- ‚¨ú Should return provider capabilities
- ‚¨ú Should support multipart upload for large files
- ‚¨ú Should handle upload cancellation

**Test Class:** `S3GlacierDeepArchiveProviderTests.cs`
**Dependencies:** AWS SDK (mock)

---

### 8.2 S3GlacierFlexibleRetrievalProvider
- ‚¨ú Should upload file with GLACIER_IR storage class
- ‚¨ú Should initiate faster retrieval (standard: 3-5 hours)
- ‚¨ú Should generate presigned URL for upload
- ‚¨ú Should handle all operations similar to Deep Archive
- ‚¨ú Should return correct retrieval time estimates

**Test Class:** `S3GlacierFlexibleRetrievalProviderTests.cs`
**Dependencies:** AWS SDK (mock)

---

### 8.3 BackblazeB2Provider
- ‚¨ú Should authenticate with Backblaze API
- ‚¨ú Should cache authentication token
- ‚¨ú Should refresh token when expired
- ‚¨ú Should upload file to B2 bucket
- ‚¨ú Should generate upload URL
- ‚¨ú Should download file from B2
- ‚¨ú Should delete file from B2
- ‚¨ú Should handle B2 API errors
- ‚¨ú Should retry on rate limit (503)
- ‚¨ú Should return instant retrieval (no delay)
- ‚¨ú Should check provider health
- ‚¨ú Should support large file upload (B2 multipart)

**Test Class:** `BackblazeB2ProviderTests.cs`
**Dependencies:** Backblaze SDK (mock)

---

### 8.4 PluginLoader
- ‚¨ú Should scan plugins directory for assemblies
- ‚¨ú Should load assembly from file
- ‚¨ú Should discover types implementing IStorageProvider
- ‚¨ú Should instantiate provider from plugin
- ‚¨ú Should validate provider has required attributes
- ‚¨ú Should handle plugin load failure gracefully
- ‚¨ú Should log plugin discovery and loading
- ‚¨ú Should skip invalid assemblies
- ‚¨ú Should support versioning of plugins
- ‚¨ú Should prevent loading duplicate providers

**Test Class:** `PluginLoaderTests.cs`
**Dependencies:** File system, Reflection

---

## Phase 9: Infrastructure Layer - Persistence

**Estimated Tests:** 40-45 test cases

### 9.1 FileRepository (EF Core Implementation)
- ‚¨ú Should add file entity to database
- ‚¨ú Should generate unique ID on insert
- ‚¨ú Should retrieve file by ID
- ‚¨ú Should return null if file not found
- ‚¨ú Should update file entity
- ‚¨ú Should handle concurrency conflicts (optimistic locking)
- ‚¨ú Should soft delete file (mark as deleted, not remove)
- ‚¨ú Should query files by user ID
- ‚¨ú Should support pagination (skip, take)
- ‚¨ú Should filter by file type
- ‚¨ú Should filter by status
- ‚¨ú Should filter by date range
- ‚¨ú Should search by filename (case-insensitive)
- ‚¨ú Should search by tags
- ‚¨ú Should check if hash exists
- ‚¨ú Should return file by hash
- ‚¨ú Should use indexes for performance
- ‚¨ú Should eager load related entities when needed
- ‚¨ú Should support unit of work (SaveChanges)

**Test Class:** `FileRepositoryTests.cs`
**Dependencies:** EF Core, In-Memory Database for testing

---

### 9.2 Database Migrations
- ‚¨ú Should create Files table with correct schema
- ‚¨ú Should create indexes on FileHash column
- ‚¨ú Should create indexes on UserId column
- ‚¨ú Should create indexes on CreatedAt column
- ‚¨ú Should create UploadSessions table
- ‚¨ú Should create Shares table
- ‚¨ú Should create RedundancyCopies table
- ‚¨ú Should support PostgreSQL
- ‚¨ú Should support SQL Server (optional)

**Test Class:** `DatabaseMigrationTests.cs`
**Dependencies:** EF Core Migrations

---

## Phase 10: Infrastructure Layer - Background Jobs

**Estimated Tests:** 20-25 test cases

### 10.1 ThumbnailGenerationJob
- ‚¨ú Should dequeue thumbnail generation message
- ‚¨ú Should download original file
- ‚¨ú Should generate thumbnails
- ‚¨ú Should upload thumbnails to S3 Standard
- ‚¨ú Should update file metadata with thumbnail URLs
- ‚¨ú Should handle job failure and retry
- ‚¨ú Should log job execution

**Test Class:** `ThumbnailGenerationJobTests.cs`
**Dependencies:** Job queue (Redis mock), IStorageProvider

---

### 10.2 ExpiredSessionCleanupJob
- ‚¨ú Should query for expired upload sessions
- ‚¨ú Should delete session metadata
- ‚¨ú Should cleanup partial uploads from storage
- ‚¨ú Should run on schedule (daily)

**Test Class:** `ExpiredSessionCleanupJobTests.cs`
**Dependencies:** IUploadSessionRepository, IStorageProvider

---

### 10.3 RedundancyVerificationJob
- ‚¨ú Should query files needing verification
- ‚¨ú Should verify checksum for each copy
- ‚¨ú Should detect corrupted copies
- ‚¨ú Should trigger repair if copy missing/corrupted
- ‚¨ú Should update verification timestamp
- ‚¨ú Should run on schedule (weekly)

**Test Class:** `RedundancyVerificationJobTests.cs`
**Dependencies:** IFileRepository, IStorageProvider

---

## Phase 11: API Layer - Controllers

**Estimated Tests:** 70-80 test cases

### 11.1 AuthController
- ‚¨ú Should return access token for valid authorization code
- ‚¨ú Should return refresh token for valid authorization code
- ‚¨ú Should return 401 for invalid authorization code
- ‚¨ú Should refresh access token with valid refresh token
- ‚¨ú Should return 401 for invalid refresh token
- ‚¨ú Should revoke tokens on logout
- ‚¨ú Should return proper token expiration times

**Test Class:** `AuthControllerTests.cs`
**Dependencies:** OAuth2 service (mock)

---

### 11.2 FilesController (Upload)
- ‚¨ú Should accept multipart form upload
- ‚¨ú Should return 201 Created with file ID
- ‚¨ú Should validate Content-Type header
- ‚¨ú Should validate file size against user tier limit
- ‚¨ú Should return 413 Payload Too Large if size exceeded
- ‚¨ú Should validate file type
- ‚¨ú Should return 400 Bad Request for invalid file type
- ‚¨ú Should require authentication
- ‚¨ú Should return 401 Unauthorized if not authenticated
- ‚¨ú Should return 429 Too Many Requests if rate limited
- ‚¨ú Should include rate limit headers in response
- ‚¨ú Should accept file metadata in request
- ‚¨ú Should validate metadata schema
- ‚¨ú Should handle duplicate file (return existing ID)

**Test Class:** `FilesControllerUploadTests.cs`
**Dependencies:** FileUploadService

---

### 11.3 FilesController (Chunked Upload)
- ‚¨ú Should initiate chunked upload
- ‚¨ú Should return upload ID and presigned URLs
- ‚¨ú Should validate initiate upload request
- ‚¨ú Should accept chunk upload
- ‚¨ú Should validate chunk MD5 hash
- ‚¨ú Should return upload progress after chunk
- ‚¨ú Should complete upload when all chunks uploaded
- ‚¨ú Should return upload status (resume)
- ‚¨ú Should cancel upload
- ‚¨ú Should return 404 if upload ID not found
- ‚¨ú Should return 409 Conflict if upload already completed

**Test Class:** `FilesControllerChunkedUploadTests.cs`
**Dependencies:** ChunkedUploadService

---

### 11.4 FilesController (Retrieval)
- ‚¨ú Should return file metadata by ID
- ‚¨ú Should return 404 if file not found
- ‚¨ú Should return thumbnail URL
- ‚¨ú Should return 202 if thumbnail still generating
- ‚¨ú Should serve thumbnail image
- ‚¨ú Should initiate Glacier retrieval
- ‚¨ú Should return retrieval ID and estimated time
- ‚¨ú Should return retrieval status
- ‚¨ú Should return download URL when ready
- ‚¨ú Should download file (redirect to presigned URL)
- ‚¨ú Should return 202 if file in Glacier and not retrieved
- ‚¨ú Should support Range requests for resumable download
- ‚¨ú Should return 206 Partial Content for range request
- ‚¨ú Should validate user owns file before retrieval
- ‚¨ú Should return 403 Forbidden if not owner

**Test Class:** `FilesControllerRetrievalTests.cs`
**Dependencies:** FileRetrievalService, ThumbnailGenerationService

---

### 11.5 FilesController (Management)
- ‚¨ú Should list files with pagination
- ‚¨ú Should filter files by type
- ‚¨ú Should filter files by date range
- ‚¨ú Should search files by query string
- ‚¨ú Should sort files by date/size/name
- ‚¨ú Should update file metadata (PATCH)
- ‚¨ú Should delete file (soft delete)
- ‚¨ú Should return 204 No Content after delete
- ‚¨ú Should batch compare hashes
- ‚¨ú Should return sync status since timestamp

**Test Class:** `FilesControllerManagementTests.cs`
**Dependencies:** FileSearchService, IFileRepository, HashComparisonService

---

### 11.6 ProvidersController
- ‚¨ú Should list available providers
- ‚¨ú Should return provider health status
- ‚¨ú Should return 503 if provider unhealthy

**Test Class:** `ProvidersControllerTests.cs`
**Dependencies:** StorageProviderFactory, IStorageProvider

---

### 11.7 QuotaController
- ‚¨ú Should return user quota information
- ‚¨ú Should return usage statistics
- ‚¨ú Should return per-provider breakdown

**Test Class:** `QuotaControllerTests.cs`
**Dependencies:** QuotaManagementService

---

### 11.8 RedundancyController
- ‚¨ú Should get redundancy status for file
- ‚¨ú Should set redundancy level
- ‚¨ú Should return 202 Accepted for async operation
- ‚¨ú Should initiate rebalancing job
- ‚¨ú Should return rebalancing job status
- ‚¨ú Should return cost estimate

**Test Class:** `RedundancyControllerTests.cs`
**Dependencies:** RedundancyManagementService, FileRebalancingService

---

### 11.9 ShareController
- ‚¨ú Should create public share
- ‚¨ú Should return share URL
- ‚¨ú Should access shared file
- ‚¨ú Should require password if set
- ‚¨ú Should return 404 if share expired
- ‚¨ú Should return 404 if max downloads exceeded
- ‚¨ú Should list shares for file
- ‚¨ú Should revoke share
- ‚¨ú Should update share settings

**Test Class:** `ShareControllerTests.cs`
**Dependencies:** FileSharingService

---

### 11.10 HealthController
- ‚¨ú Should return 200 OK when healthy
- ‚¨ú Should check database connectivity
- ‚¨ú Should check storage provider health
- ‚¨ú Should return 503 Service Unavailable if unhealthy
- ‚¨ú Should return component-level health details

**Test Class:** `HealthControllerTests.cs`
**Dependencies:** All services

---

## Phase 12: Integration Tests

**Goal:** End-to-end flows across all layers
**Estimated Tests:** 30-35 test cases

### 12.1 Upload Flow Integration Tests
- ‚¨ú Should upload small photo end-to-end
- ‚¨ú Should upload large video with chunking
- ‚¨ú Should generate thumbnails after upload
- ‚¨ú Should detect and skip duplicate upload
- ‚¨ú Should handle upload failure and rollback
- ‚¨ú Should respect rate limits
- ‚¨ú Should respect quota limits
- ‚¨ú Should support upload cancellation

**Test Class:** `UploadFlowIntegrationTests.cs`
**Environment:** Test database, Mock S3

---

### 12.2 Retrieval Flow Integration Tests
- ‚¨ú Should retrieve file from S3 Glacier
- ‚¨ú Should poll retrieval status until ready
- ‚¨ú Should download file when ready
- ‚¨ú Should handle retrieval timeout
- ‚¨ú Should serve thumbnail immediately

**Test Class:** `RetrievalFlowIntegrationTests.cs`
**Environment:** Test database, Mock S3

---

### 12.3 Multi-Provider Integration Tests
- ‚¨ú Should upload to S3 Glacier Deep Archive
- ‚¨ú Should upload to S3 Glacier Flexible
- ‚¨ú Should upload to Backblaze
- ‚¨ú Should switch providers dynamically
- ‚¨ú Should rebalance files between providers
- ‚¨ú Should maintain access to all files after rebalancing

**Test Class:** `MultiProviderIntegrationTests.cs`
**Environment:** Mock multiple providers

---

### 12.4 Redundancy Integration Tests
- ‚¨ú Should create redundant copies across providers
- ‚¨ú Should verify checksums match
- ‚¨ú Should detect and repair missing copy
- ‚¨ú Should complete redundancy despite Glacier delays

**Test Class:** `RedundancyIntegrationTests.cs`
**Environment:** Test database, Mock providers

---

### 12.5 Authentication & Authorization Tests
- ‚¨ú Should reject unauthenticated requests
- ‚¨ú Should accept valid access token
- ‚¨ú Should refresh expired token
- ‚¨ú Should prevent user from accessing other user's files

**Test Class:** `AuthIntegrationTests.cs`
**Environment:** Test OAuth server

---

## Test Metrics & Coverage

### Coverage Goals
- **Domain Layer:** 100% (pure logic, no dependencies)
- **Application Layer:** 95%+ (core business flows)
- **Infrastructure Layer:** 85%+ (external dependencies)
- **API Layer:** 90%+ (controllers, validation)
- **Overall:** 90%+

### Test Execution Time Goals
- **Unit Tests:** < 5 minutes for all
- **Integration Tests:** < 10 minutes for all
- **Full Suite:** < 15 minutes

### Continuous Integration
- Run unit tests on every commit
- Run integration tests on PR
- Run full suite before merge to main
- Block merge if coverage drops below 90%

---

## Test Data Management

### Test Fixtures
- **Small Image:** 1MB JPEG (test-data/sample-photo.jpg)
- **Large Image:** 50MB HEIC (test-data/large-photo.heic)
- **Small Video:** 10MB MP4 (test-data/sample-video.mp4)
- **Large Video:** 500MB MOV (test-data/large-video.mov)
- **PDF File:** 5MB (test-data/document.pdf)

### Mock Data Builders
```csharp
public class FileBuilder
{
    public File Build() { ... }
    public FileBuilder WithSize(long bytes) { ... }
    public FileBuilder WithType(string mimeType) { ... }
    public FileBuilder AsArchived() { ... }
}
```

---

## Next Steps

1. ‚úÖ Review and approve this test plan
2. ‚¨ú Setup project structure (.NET 8 solution)
3. ‚¨ú Configure xUnit and FluentAssertions
4. ‚¨ú Start Phase 1: Domain Layer Value Objects
5. ‚¨ú Follow TDD cycle: Red ‚Üí Green ‚Üí Refactor

**Ready to start coding?** Let me know when to proceed!

---

**Last Updated:** 2025-10-25
**Document Owner:** FlexStorage Team
